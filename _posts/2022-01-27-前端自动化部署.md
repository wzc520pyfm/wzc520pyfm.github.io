---
layout: post
title: 'å‰ç«¯è‡ªåŠ¨åŒ–éƒ¨ç½²'
subtitle: 'æ‘†è„±å¼€å‘5åˆ†é’Ÿéƒ¨ç½²åŠå°æ—¶çš„å°´å°¬'
date: 2022-01-27
categories: æŠ€æœ¯
author: lalala
cover: 
tags: å‰ç«¯
---

## å‰ç«¯è‡ªåŠ¨åŒ–éƒ¨ç½²



æœ¬æ–‡å‚è€ƒè‡ª: ä½œè€…ï¼šyeyan1996 é“¾æ¥ï¼šhttps://juejin.cn/post/6845166890420011021 æ¥æºï¼šç¨€åœŸæ˜é‡‘ è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚



### dockerç®€ä»‹

å¼€å‘5åˆ†é’Ÿï¼Œæ‰“åŒ…åŠå°æ—¶, æ—©å·²æ˜¯å‰ç«¯çš„ç—›ç‚¹, æ›´ç€, å¼€å‘è€…è‡ªèº«ç¯å¢ƒçš„å·®å¼‚ä¼šå¯¼è‡´æœ€ç»ˆçš„äº§ç‰©ä¹Ÿæœ‰ä¸åŒ

docker å¯ä»¥çµæ´»çš„åˆ›å»º/é”€æ¯/ç®¡ç†å¤šä¸ªâ€œæœåŠ¡å™¨â€ï¼Œè¿™äº›â€œæœåŠ¡å™¨â€è¢«ç§°ä¸º `å®¹å™¨ (container)`

åœ¨å®¹å™¨ä¸­ä½ å¯ä»¥åšä»»ä½•æœåŠ¡å™¨å¯ä»¥åšçš„äº‹ï¼Œä¾‹å¦‚åœ¨æœ‰ node ç¯å¢ƒçš„å®¹å™¨ä¸­è¿è¡Œ `npm run build` æ‰“åŒ…é¡¹ç›®ï¼Œåœ¨æœ‰ nginx ç¯å¢ƒçš„å®¹å™¨ä¸­éƒ¨ç½²é¡¹ç›®ï¼Œåœ¨æœ‰ mysql ç¯å¢ƒçš„å®¹å™¨ä¸­åšæ•°æ®å­˜å‚¨ç­‰ç­‰

ä¸€æ—¦æœåŠ¡å™¨å®‰è£…äº† docker ï¼Œå°±å¯ä»¥è‡ªç”±åˆ›å»ºä»»æ„å¤šçš„å®¹å™¨ï¼Œä¸Šå›¾ä¸­ docker çš„ logo å½¢è±¡çš„å±•ç¤ºäº†å®ƒä»¬ä¹‹é—´çš„å…³ç³»ï¼ŒğŸ³å°±æ˜¯ dockerï¼Œä¸Šé¢çš„ä¸€ä¸ªä¸ªé›†è£…ç®±å°±æ˜¯å®¹å™¨



### æœ¬æœºå®‰è£…docker

å®˜æ–¹ä¸‹è½½åœ°å€: [Get Started with Docker \| Docker](https://www.docker.com/get-started)

ä¸‹è½½æ—¶æœ€å¥½é¡ºæ‰‹ä¹Ÿæ³¨å†Œä¸€ä¸ªdockerHub

æˆ‘çš„ç”µè„‘æ˜¯windows, å®‰è£…å®Œæˆåç‚¹å‡»dockerå›¾æ ‡å¯åŠ¨docker, åœ¨ç»ˆç«¯è¾“å…¥`docker`, çœ‹åˆ°å¦‚ä¸‹è¾“å‡ºåˆ™ä»£è¡¨dockeræ­£å¸¸è¿è¡Œ

![image-20220127112024967](https://cdn.jsdelivr.net/gh/wzc520pyfm/Picbed_PicGo@master/img/20220127220227-16432922137166.png)

* è¡¥å……: 

  åœ¨æ­¤ä½ æ‰“å¼€docker, å¯èƒ½ä¼šçœ‹åˆ°dockeræ˜¯çº¢è‰²çš„, æ­¤æ—¶ä½ å¯ä»¥åœ¨ç»ˆç«¯è¿›å…¥dockerç›®å½•, è¿è¡Œ`DockerCli.exe -SwitchDaemon`

  1. > cd "C:\Program Files\Docker\Docker"

  2. > DockerCli.exe -SwitchDaemon
     >
     > // æ‰§è¡Œå¤±è´¥æ—¶æ‰§è¡Œ
     >
     > ./DockerCli.exe -SwitchDaemon

  å¦‚æœæ‰§è¡Œä¸Šè¿°æ­¥éª¤å, dockerä»ç„¶æ˜¯çº¢è‰², è€Œä¸”æ— æ³•æ‰§è¡Œdockerå…¶ä»–å‘½ä»¤(å‡ºç°error), ä¾‹å¦‚

  ![image-20220127114210359](https://cdn.jsdelivr.net/gh/wzc520pyfm/Picbed_PicGo@master/img/image-20220127114210359.png)

  é‚£å°±åªèƒ½ä¾ç…§è½¯ä»¶æç¤ºå®‰è£…Linuxå†…æ ¸

  ![image-20220127114252177](https://cdn.jsdelivr.net/gh/wzc520pyfm/Picbed_PicGo@master/img/image-20220127114252177.png)

  ç‚¹å‡»è¿›å…¥ç½‘å€åä¾ç…§æ“ä½œè¿›è¡Œä¸‹è½½å®‰è£…  https://aka.ms/wsl2kernel

  1. ä¸‹è½½æœ€æ–°çš„é€‚ç”¨äºx64è®¡ç®—æœºçš„æ›´æ–°åŒ…

     å¦‚æœä¸ç¡®å®šè‡ªå·±è®¡ç®—æœºçš„ç±»å‹, æ‰“å¼€PowerShellè¾“å…¥`systeminfo | find "ç³»ç»Ÿç±»å‹"`, å¦‚æœä½ çœ‹åˆ°å¦‚ä¸‹è¾“å‡º,åˆ™ä»£è¡¨è®¡ç®—æœºæ˜¯x64ç±»å‹çš„:

     ![image-20220127114551128](https://cdn.jsdelivr.net/gh/wzc520pyfm/Picbed_PicGo@master/img/image-20220127114551128.png)

     ä¸‹è½½å®‰è£…å®Œæˆååœ¨PowerShellè¿è¡Œå¦‚ä¸‹å‘½ä»¤, å°†WSL2è®¾ä¸ºé»˜è®¤ç‰ˆæœ¬

     > wsl --set-default-version 2
     
     æ¥ç€å†æ¬¡æ‰§è¡Œ:
     
     > cd "C:\Program Files\Docker\Docker"
     >
     > DockerCli.exe -SwitchDaemon
     
     å¦‚æœè¿˜æ˜¯å‡ºç°é”™è¯¯, é‚£å°±é‡å¯ç”µè„‘å†è¯•ä¸€æ¬¡å§(æˆ‘æœ‰ä¸€æ¬¡å°±æ˜¯è¿™æ ·, é‡å¯ä¹‹åæ‰§è¡Œä¸Šè¿°å‘½ä»¤å°±å¥½äº†)

dockeræ¦‚å¿µ:

* é•œåƒ(image)
* å®¹å™¨(container)
* ä»“åº“(repositiory)

å®¹å™¨å¯ä»¥ç±»æ¯”ä¸€ä¸ªæœåŠ¡å™¨, é•œåƒåˆ™æ˜¯åˆ›å»ºå®¹å™¨çš„æ¨¡æ¿, ä¸€ä¸ªdockeré•œåƒå¯ä»¥åˆ›å»ºå¤šä¸ªå®¹å™¨

æœ‰ä¸¤ç§è·å–é•œåƒçš„æ–¹å¼:

* Dockerfileæ–‡ä»¶åˆ›å»º
* ä½¿ç”¨dockerHubæˆ–å…¶ä»–ä»“åº“ä¸Šç°æœ‰çš„é•œåƒ



### åˆ›å»ºdockeré•œåƒ

é¦–å…ˆåˆ›å»ºä¸€ä¸ª`hello-docker`ç›®å½•, åœ¨ç›®å½•ä¸­åˆ›å»º`index.html`å’Œ`Dockerfile`æ–‡ä»¶

```html
<!--index.html-->
<h1>Hello docker</h1>
```

```dockerfile
# Dockerfile
FROM nginx
COPY index.html /usr/share/nginx/html/index.html
EXPOSE 80
```

* Dockerfileå†…å®¹è§£æ:

  * FROM nginxï¼šåŸºäºå®˜æ–¹ nginx é•œåƒ

  * COPY index.html /usr/share/nginx/html/index.htmlï¼š**å°†å½“å‰ç›®å½•ä¸‹ index.html æ›¿æ¢å®¹å™¨ä¸­ /usr/share/nginx/html/index.html æ–‡ä»¶ï¼Œ `/usr/share/nginx/html` æ˜¯å®¹å™¨ä¸­ nginx é»˜è®¤å­˜æ”¾ç½‘é¡µæ–‡ä»¶çš„ç›®å½•ï¼Œè®¿é—®å®¹å™¨ 80 ç«¯å£ä¼šå±•ç¤ºè¯¥ç›®å½•ä¸‹ index.html æ–‡ä»¶**

  * EXPOSE 80ï¼šå®¹å™¨å¯¹å¤–æš´éœ² 80 ç«¯å£ï¼Œä¸»è¦èµ·å£°æ˜ä½œç”¨ï¼ŒçœŸå®ç«¯å£æ˜ å°„è¿˜éœ€è¦åœ¨åˆ›å»ºå®¹å™¨æ—¶å®šä¹‰

* ç›®å‰çš„æ–‡ä»¶ç»“æ„:

  ```
  hello-docker
    |____index.html
    |____Dockerfile
  ```

åœ¨å½“å‰ç›®å½•(é¡¹ç›®ç›®å½•)è¿è¡Œä»¥ä¸‹å‘½ä»¤åˆ›å»ºdokeré•œåƒ

> docker build . -t test-image:latest 

* å‘½ä»¤è§£æ: 
  - buildï¼šåˆ›å»º docker é•œåƒ
  - .ï¼šä½¿ç”¨å½“å‰ç›®å½•ä¸‹çš„ dockerfile æ–‡ä»¶
  - -tï¼šä½¿ç”¨ tag æ ‡è®°ç‰ˆæœ¬
  - test-image:latestï¼šåˆ›å»ºåä¸º `test-image` çš„é•œåƒï¼Œå¹¶æ ‡è®°ä¸º latestï¼ˆæœ€æ–°ï¼‰ç‰ˆæœ¬

åˆ›å»ºå®Œæˆå, å¯ä»¥é€šè¿‡`docker images`å‘½ä»¤æŸ¥çœ‹æ‰€æœ‰é•œåƒ

![image-20220127122327921](https://cdn.jsdelivr.net/gh/wzc520pyfm/Picbed_PicGo@master/img/image-20220127122327921.png)



### åˆ›å»ºdockerå®¹å™¨

é•œåƒæˆåŠŸåˆ›å»ºå, è¿è¡Œä»¥ä¸‹å‘½ä»¤å¯ä»¥åˆ›å»ºä¸€ä¸ªdockerå®¹å™¨

> docker run -d -p 8081:80  --name test-container test-image:latest

* å‘½ä»¤è§£æ:

  * runï¼šåˆ›å»ºå¹¶è¿è¡Œ docker å®¹å™¨

  * -dï¼š åå°è¿è¡Œå®¹å™¨

  * 8081:80ï¼šå°†å½“å‰æœåŠ¡å™¨çš„ 8081 ç«¯å£ï¼ˆå†’å·å‰çš„ 8081ï¼‰ï¼Œæ˜ å°„åˆ°å®¹å™¨çš„ 80 ç«¯å£ï¼ˆå†’å·åçš„ 80ï¼‰

  * --nameï¼šç»™å®¹å™¨å‘½åï¼Œä¾¿äºä¹‹åå®šä½å®¹å™¨

  * test-image:latestï¼šåŸºäº `test-image` æœ€æ–°ç‰ˆæœ¬çš„é•œåƒåˆ›å»ºå®¹å™¨

é€šè¿‡`docker ps -a`å‘½ä»¤æŸ¥çœ‹æ‰€æœ‰å®¹å™¨

![image-20220127123344952](https://cdn.jsdelivr.net/gh/wzc520pyfm/Picbed_PicGo@master/img/image-20220127123344952.png)

ç°åœ¨åœ¨æœ¬åœ°æµè§ˆå™¨è¾“å…¥: `localhost:8081`å³å¯è®¿é—®æœåŠ¡å†…å®¹(å³é¡¹ç›®ä¸­çš„index.html)

![image-20220127123445069](https://cdn.jsdelivr.net/gh/wzc520pyfm/Picbed_PicGo@master/img/image-20220127123445069.png)

* dockerå…¶ä»–å‘½ä»¤

  * åœæ­¢ã€å¯åŠ¨ã€æ€æ­»ã€é‡å¯ä¸€ä¸ªå®¹å™¨

    > docker stop Nameæˆ–è€…ID 
    > docker start Nameæˆ–è€…ID 
    > docker kill Nameæˆ–è€…ID 
    > docker restart nameæˆ–è€…ID

  * åˆ é™¤æ‰€æœ‰åœæ­¢çš„å®¹å™¨

    > docker container prune

  * æŸ¥çœ‹æ‰€æœ‰ name ä»¥ docker å¼€å¤´çš„ docker å®¹å™¨ï¼Œå¹¶åªè¾“å‡ºå®¹å™¨å

    > docker ps -a -f "name=^docker" --format="{{.Names}}"

  * åœæ­¢ name ä¸º docker-container çš„å®¹å™¨

    > docker stop docker-container

  * åˆ é™¤ name ä¸º docker-container çš„å®¹å™¨ï¼ˆåœæ­¢çŠ¶æ€çš„å®¹å™¨æ‰èƒ½è¢«åˆ é™¤ï¼‰

    > docker rm docker-container



### dockerHub

dockerhubæ˜¯å­˜å‚¨é•œåƒçš„ä»“åº“, å¼€å‘è€…å¯ä»¥å°† Dockerfile ç”Ÿæˆçš„é•œåƒä¸Šä¼ åˆ° dockerhub æ¥å­˜å‚¨è‡ªå®šä¹‰é•œåƒï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨å®˜æ–¹æä¾›çš„é•œåƒ

* ä½¿ç”¨å®˜æ–¹é•œåƒå¯åŠ¨ä¸€ä¸ªå®¹å™¨

  > docker pull nginx 

  > docker run -d -p 81:80  --name nginx-container nginx

  ç¬¬ä¸€æ­¥æ‹‰å–äº†å®˜æ–¹çš„ nginx é•œåƒ

  ç¬¬äºŒæ­¥ç”¨åŸºäºå®˜æ–¹ nginx é•œåƒåˆ›å»ºåä¸º `nginx-container` çš„å®¹å™¨

  è¿™é‡Œä½¿ç”¨ 81 ç«¯å£æ˜ å°„åˆ°å®¹å™¨çš„ 80 ç«¯å£ï¼Œè®¿é—® `localhost:81` å¯ä»¥çœ‹åˆ° nginx å¯åŠ¨é¡µé¢

![image-20220127124048928](https://cdn.jsdelivr.net/gh/wzc520pyfm/Picbed_PicGo@master/img/image-20220127124048928.png)



### dockerçš„å¥½å¤„

dockerå°†ç¯å¢ƒç»Ÿä¸€èµ·æ¥, ä¿è¯ç”Ÿæˆç¯å¢ƒå’Œå¼€å‘ç¯å¢ƒé¡¹ç›®å‡èƒ½æ­£å¸¸è¿è¡Œ

å¼€å‘è€…å°†å¼€å‘ç¯å¢ƒç”¨dockeré•œåƒä¸Šä¼ åˆ°dockerä»“åº“, åœ¨ç”Ÿæˆç¯å¢ƒæ‹‰å–å¹¶è¿è¡Œç›¸åŒç¯å¢ƒå³å¯ä¿æŒç¯å¢ƒä¸€ç›´

* æäº¤åä¸º`docker-test-image`çš„é•œåƒ, é•œåƒåå‰åŠ ä¸Šdockerhubè´¦å·ä½œä¸ºå‰ç¼€

  > docker push wzc520pyfm/docker-test-image:latest

* æœåŠ¡å™¨æ‹‰å–è´¦å·`wzc520pyfm`ä¸‹çš„`docker-test-image`é•œåƒ

  > docker pull wzc520pyfm/docker-test-image:latest

dockerä¹Ÿæœ‰ç‰ˆæœ¬æ§åˆ¶, åœ¨åˆ›å»ºé•œåƒæ—¶å¯ä»¥ä½¿ç”¨tagæ ‡è®°ç‰ˆæœ¬, å¦‚æœæŸä¸ªç‰ˆæœ¬çš„ç¯å¢ƒæœ‰é—®é¢˜, å¯ä»¥å¿«é€Ÿå›æ»šåˆ°ä¹‹å‰çš„ç‰ˆæœ¬

dockerå°†é¡¹ç›®æ„å»ºéœ€è¦çš„ç¯å¢ƒæ”¾åœ¨å®¹å™¨ä¸­, ä¸æœåŠ¡å™¨éš”ç¦»

å®¹å™¨åˆ›å»ºå’Œé”€æ¯éƒ½ååˆ†é«˜æ•ˆ



### é«˜æ•ˆçš„å‰ç«¯è‡ªåŠ¨åŒ–éƒ¨ç½²

æ²¡æœ‰è‡ªåŠ¨åŒ–çš„éƒ¨ç½², æˆ‘ä»¬éœ€è¦ `npm run build`ç”Ÿæˆæ„å»ºäº§ç‰©(dist), å°†distæ–‡ä»¶ä¸Šä¼ åˆ°æœåŠ¡å™¨, åŒæ—¶è¿˜éœ€è¦å°†ä»£ç æäº¤åˆ°ä»“åº“(å›¢é˜Ÿåˆä½œæ€»è¦æäº¤çš„å§).

å®ç°è‡ªåŠ¨åŒ–éƒ¨ç½²å, æˆ‘ä»¬è¦åšçš„ä»…ä»…æ˜¯`git push`æäº¤ä»£ç åˆ°ä»“åº“, å…¶ä½™å‡ç”±è„šæœ¬è‡ªåŠ¨æ‰§è¡Œ.

* è„šæœ¬éœ€è¦åšçš„äº‹:
  * è‡ªåŠ¨æ›´æ–°é•œåƒ
  * é•œåƒä¸­è‡ªåŠ¨è¿è¡Œ`npm run build`ç”Ÿæˆæ„å»ºäº§ç‰©
  * è‡ªåŠ¨åˆ›å»ºå®¹å™¨



### ç™»å½•Linuxäº‘æœåŠ¡å™¨

å‚è€ƒå„å¤§äº‘æœåŠ¡å™¨å‚å•†å®˜æ–¹æ–‡æ¡£, é™„ä¸Šè…¾è®¯äº‘CentOSç™»å½•æŒ‡å—æ–‡æ¡£: [è½»é‡åº”ç”¨æœåŠ¡å™¨ ä½¿ç”¨è¿œç¨‹ç™»å½•è½¯ä»¶ç™»å½• Linux å®ä¾‹ - æ“ä½œæŒ‡å— - æ–‡æ¡£ä¸­å¿ƒ - è…¾è®¯äº‘ (tencent.com)](https://cloud.tencent.com/document/product/1207/44578)

æˆ‘çš„æ˜¯è…¾è®¯äº‘`CentOS 7.6 64ä½`çš„æ“ä½œç³»ç»Ÿ, å­¦ç”Ÿè´­ä¹°äº‘æœåŠ¡å™¨æœ‰ä¼˜æƒ , åº”è¯¥æ˜¯`99`/å¹´



### LinuxæœåŠ¡å™¨å®‰è£…å¿…è¦çš„ç³»ç»Ÿå·¥å…·

å®‰è£…å¿…è¦å·¥å…·

> sudo yum install -y yum-utils

æ·»åŠ è½¯ä»¶è½¯ä»¶æº, ä½¿ç”¨é˜¿é‡Œäº‘é•œåƒ

> sudo yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo



### Linuxå®‰è£…docker

å®‰è£…docker

> sudo yum install docker-ce docker-ce-cli containerd.io

å¼€å¯dockeræœåŠ¡

> sudo systemctl start docker

è¿è¡Œhello-worldé¡¹ç›®

> sudo docker run hello-world

å¦‚æœèƒ½å¤Ÿçœ‹åˆ°è¾“å‡º`Hello from Docker!`, è¯æ˜Dockerå®‰è£…æˆåŠŸ

![img](https://cdn.jsdelivr.net/gh/wzc520pyfm/Picbed_PicGo@master/img/172ee77eb654c5cbtplv-t2oaga2asx-watermark.awebp)



### Linuxå®‰è£…git

ç”¨äºä»ä»£ç ä»“åº“æ‹‰å–ä»£ç 

> yum install git



### Linuxå®‰è£…nvm

å‰ç«¯è‡ªåŠ¨åŒ–éƒ¨ç½², é‚£å½“ç„¶å¤„ç†é€»è¾‘æ˜¯ç”¨jsæ¥å†™, nodeå¯ä»¥è®©jsåœ¨æœåŠ¡ç«¯è¿è¡Œ

nvm: ç®¡ç†nodeç‰ˆæœ¬

å®˜æ–¹åœ°å€: [nvm-sh/nvmï¼šèŠ‚ç‚¹ç‰ˆæœ¬ç®¡ç†å™¨ - ç¬¦åˆ POSIX æ ‡å‡†çš„ bash è„šæœ¬ï¼Œç”¨äºç®¡ç†å¤šä¸ªä¸»åŠ¨èŠ‚ç‚¹.jsç‰ˆæœ¬ (github.com)](https://github.com/nvm-sh/nvm)

é¦–å…ˆè¿è¡Œå®‰è£…å‘½ä»¤: 

> curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.34.0/install.sh \| bash

å®‰è£…æ—¶è¾“å‡ºç¤ºä¾‹å¦‚ä¸‹:

> [root@VM-12-9-centos /]# curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.34.0/install.sh | bash
>   % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
>                                  Dload  Upload   Total   Spent    Left  Speed
> 100 13226  100 13226    0     0   7281      0  0:00:01  0:00:01 --:--:--  7283
> => Downloading nvm from git to '/root/.nvm'
> => Cloning into '/root/.nvm'...
> remote: Enumerating objects: 278, done.
> remote: Counting objects: 100% (278/278), done.
> remote: Compressing objects: 100% (245/245), done.
> remote: Total 278 (delta 31), reused 101 (delta 20), pack-reused 0
> Receiving objects: 100% (278/278), 142.25 KiB | 54.00 KiB/s, done.
> Resolving deltas: 100% (31/31), done.
> => Compressing and cleaning up git repository
>
> => nvm source string already in /root/.bashrc
> => Appending bash_completion source string to /root/.bashrc
> => Close and reopen your terminal to start using nvm or run the following to use it now:
>
> export NVM_DIR="$HOME/.nvm"
> [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"  # This loads nvm
> [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"  # This loads nvm bash_completion

ç¨‹åºè‡ªåŠ¨åœ°å°è¯•å°†ç¯å¢ƒå˜é‡æ·»åŠ åˆ°æ­£ç¡®çš„ä½ç½®, åœ¨æ­¤ä¹‹å, æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨è¿è¡Œä½¿èƒ½å‘½ä»¤,è®©ç¯å¢ƒå˜é‡ç”Ÿæ•ˆ

> source ~/.bashrc

éªŒè¯æ˜¯å¦å®‰è£…æˆåŠŸ

> command -v nvm

æ­£å¸¸è¾“å‡ºç¤ºä¾‹:

> [root@VM-12-9-centos /]# command -v nvm
> nvm



### Linuxå®‰è£…node

ä¸‹è½½ã€ç¼–è¯‘ã€å®‰è£…æœ€æ–°ç‰ˆæœ¬çš„nodeï¼š (æœ¬æ¬¡æ“ä½œæ‰§è¡Œæ­¤å‘½ä»¤)

> nvm install node # "node" is an alias for the latest version

å¦‚æœéœ€è¦å®‰è£…ç‰¹å®šç‰ˆæœ¬çš„node, è¯·è¿è¡Œ:

> nvm install 14.7.0 # or 16.3.0, 12.22.1, etc

å®‰è£…çš„ç¬¬ä¸€ä¸ªç‰ˆæœ¬å°†æˆä¸ºé»˜è®¤ç‰ˆæœ¬ã€‚æ–° shell å°†ä»èŠ‚ç‚¹çš„é»˜è®¤ç‰ˆæœ¬ï¼ˆä¾‹å¦‚ï¼‰ å¼€å§‹ã€‚

å…¶ä»–å‘½ä»¤: 

* åˆ‡æ¢nodeç‰ˆæœ¬

  > nvm use 14.17.3

* åˆ—å‡ºå·²å®‰è£…çš„nodeç‰ˆæœ¬

  > nvm ls

* å¸è½½æŒ‡å®šç‰ˆæœ¬çš„node

  > nvm uninstall 14.17.3



### Linuxå®‰è£…pm2

pm2å¯ä»¥è®©æˆ‘ä»¬çš„jsè„šæœ¬åœ¨æœåŠ¡å™¨åå°è¿è¡Œ

> npm i pm2 -g



### åˆ›å»ºå‰ç«¯é¡¹ç›®

æœ¬åœ°åˆ›å»ºä¸€ä¸ªç®€å•çš„å‰ç«¯åŸºç¡€é¡¹ç›®

> vue create docker-test

åˆ›å»ºå®Œæˆåå°†demoä¸Šä¼ åˆ°github (å»ºè®®åˆ›å»ºpublicå…±æœ‰ä»“åº“, è¿™æ ·å¯ä»¥å…å»é‰´æƒç›´æ¥clone, å¦‚æœåˆ›å»ºäº†privateç§æœ‰ä»“åº“, åœ¨è¿è¡Œæ—¶éœ€è¦è¾“å…¥å¯†ç , ä»£ç è¿è¡Œæ—¶å½“ç„¶ä¸å¸Œæœ›è¿™æ ·, è§£å†³åŠæ³•æ˜¯ä½¿ç”¨token, å‚è§: [(37æ¡æ¶ˆæ¯) ã€çªå‘ã€‘è§£å†³remote: Support for password authentication was removed on August 13, 2021. Please use a perso_æ—¥ç§¯æœˆç´¯ï¼Œå¤©é“é…¬å‹¤-CSDNåšå®¢](https://blog.csdn.net/yjw123456/article/details/119696726)) , æ¥ä¸‹æ¥é…ç½®webhook



### webhook

githubä»“åº“æœ‰ä¸€ä¸ªhook(**é’©å­**), å®ƒä¼šåœ¨å½“å‰ä»“åº“è§¦å‘æŸäº›äº‹ä»¶æ—¶, å‘é€ä¸€ä¸ªpostå½¢å¼çš„httpè¯·æ±‚

`å½“ä»“åº“æœ‰æäº¤ä»£ç æ—¶ï¼Œé€šè¿‡å°† webhook è¯·æ±‚åœ°å€æŒ‡å‘äº‘æœåŠ¡å™¨ IP åœ°å€ï¼Œäº‘æœåŠ¡å™¨å°±èƒ½çŸ¥é“é¡¹ç›®æœ‰æ›´æ–°ï¼Œä¹‹åè¿è¡Œç›¸å…³ä»£ç å®ç°è‡ªåŠ¨åŒ–éƒ¨ç½²`

* é…ç½®**webhook**

  ![image-20220127090737223](https://cdn.jsdelivr.net/gh/wzc520pyfm/Picbed_PicGo@master/img/image-20220127090737223.png)

  ![image-20220127091223460](https://cdn.jsdelivr.net/gh/wzc520pyfm/Picbed_PicGo@master/img/image-20220127091223460.png)

* æµ‹è¯•æ˜¯å¦é…ç½®æˆåŠŸ

  1. æœ¬åœ°ä¿®æ”¹ä»£ç å¹¶æäº¤åˆ°ä»“åº“
  2. ![image-20220127091655811](https://cdn.jsdelivr.net/gh/wzc520pyfm/Picbed_PicGo@master/img/image-20220127091655811.png)

â€‹		å‚æ•°ä¸»è¦æ¶‰åŠå½“å‰ä»“åº“å’Œæœ¬åœ°æäº¤çš„ä¿¡æ¯ï¼Œè¿™é‡Œæˆ‘ä»¬åªç”¨ `repository.name` è·å–æ›´æ–°çš„ä»“åº“åå³å¯



### è¯·æ±‚å¦‚ä½•å¤„ç†?

å½“æˆ‘ä»¬çš„æœåŠ¡å™¨æ”¶åˆ°é¡¹ç›®æ›´æ–°åå‘é€çš„postè¯·æ±‚å, éœ€è¦åˆ›å»º/æ›´æ–°é•œåƒæ¥å®ç°è‡ªåŠ¨åŒ–éƒ¨ç½²



### åˆ›å»ºDockerfile

åœ¨æœ¬åœ°é¡¹ç›®é‡Œæ–°å»ºä¸€ä¸ªDockerfileæ–‡ä»¶, ç”¨äºä¹‹ååˆ›å»ºé•œåƒ

```dockerfile
# dockerfile
# build stage
FROM registry.cn-hangzhou.aliyuncs.com/dyjutil/node:v14.8.0 as build-stage
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build

# production stage
FROM nginx:stable-alpine as production-stage
COPY --from=build-stage /app/dist /usr/share/nginx/html
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

* é…ç½®è§£æ

  - FROM registry.cn-hangzhou.aliyuncs.com/dyjutil/node:v14.8.0 as build-stageï¼šé‡‡ç”¨é˜¿é‡Œç‰ˆæœ¬å¢ƒåƒçš„é˜¶æ®µå‘½åä¸º `build-stage`
  - WORKDIR /appï¼šå°†å·¥ä½œåŒºè®¾ä¸º /appï¼Œå’Œå…¶ä»–ç³»ç»Ÿæ–‡ä»¶éš”ç¦»
  - COPY package*.json ./ï¼šæ‹·è´ package.json/package-lock.json åˆ°å®¹å™¨çš„ /app ç›®å½•
  - RUN npm installï¼šè¿è¡Œ `npm install` åœ¨å®¹å™¨ä¸­å®‰è£…ä¾èµ–
  - COPY . .ï¼šæ‹·è´å…¶ä»–æ–‡ä»¶åˆ°å®¹å™¨ /app ç›®å½•ï¼Œåˆ†ä¸¤æ¬¡æ‹·è´æ˜¯å› ä¸ºä¿æŒ node_modules ä¸€è‡´
  - RUN npm run buildï¼šè¿è¡Œ `npm run build` åœ¨å®¹å™¨ä¸­æ„å»º

  è¿™é‡Œç”¨åˆ°äº† docker ä¸€ä¸ªæŠ€å·§ï¼š[å¤šé˜¶æ®µæ„å»º](https://link.juejin.cn?target=https%3A%2F%2Fdocs.docker.com%2Fdevelop%2Fdevelop-images%2Fmultistage-build%2F)

  å°†æ„å»ºåˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼Œç¬¬ä¸€é˜¶æ®µåŸºäº node é•œåƒï¼Œç¬¬äºŒé˜¶æ®µåŸºäº nginx é•œåƒ

  - FROM nginx:lts-alpine as production-stageï¼šåŸºäº nginx  `stable-alpine` ç‰ˆæœ¬é•œåƒï¼Œå¹¶å°†æœ‰ nginx ç¯å¢ƒçš„é˜¶æ®µå‘½åä¸º `production-stage`
  - COPY --from=build-stage /app/dist /usr/share/nginx/htmlï¼šé€šè¿‡ --form å‚æ•°å¯ä»¥**å¼•ç”¨ `build-stage` é˜¶æ®µç”Ÿæˆçš„äº§ç‰©**ï¼Œå°†å…¶å¤åˆ¶åˆ° /usr/share/nginx/html
  - EXPOSE 80ï¼šå®¹å™¨å¯¹å¤–æš´éœ² 80 ç«¯å£
  - CMD ["nginx", "-g", "daemon off;"]ï¼šå®¹å™¨åˆ›å»ºæ—¶è¿è¡Œ `nginx -g daemon off` å‘½ä»¤ï¼Œ`ä¸€æ—¦ CMD å¯¹åº”çš„å‘½ä»¤ç»“æŸï¼Œå®¹å™¨å°±ä¼šè¢«é”€æ¯`ï¼Œæ‰€ä»¥é€šè¿‡ daemon off è®© nginx ä¸€ç›´åœ¨å‰å°è¿è¡Œ

é€šè¿‡`scp`å‘½ä»¤, å°†Dockerfileæ–‡ä»¶å¤åˆ¶åˆ°äº‘æœåŠ¡å™¨ä¸Š

> scp ./Dockerfile root@121.5.110.8:/root

![image-20220127131456618](https://cdn.jsdelivr.net/gh/wzc520pyfm/Picbed_PicGo@master/img/image-20220127131456618.png)



### åˆ›å»º.dockerignore

.dockerignore å¯ä»¥åœ¨åˆ›å»ºé•œåƒå¤åˆ¶æ–‡ä»¶æ—¶å¿½ç•¥å¤åˆ¶æŸäº›æ–‡ä»¶

åœ¨æœ¬åœ°é¡¹ç›®é‡Œæ–°å»º`.dockerignore`

```
# .dockerignore
node_modules
```

æ¥ç€å°†`.dockerignore`æ–‡ä»¶ä¹Ÿå¤åˆ¶åˆ°äº‘æœåŠ¡å™¨ä¸Š

> scp ./.dockerignore root@121.5.110.8:/root

![image-20220127132047601](https://cdn.jsdelivr.net/gh/wzc520pyfm/Picbed_PicGo@master/img/image-20220127132047601.png)



### åˆ›å»ºhttpæœåŠ¡å™¨å¹¶ç¼–å†™è‡ªåŠ¨éƒ¨ç½²è„šæœ¬

ä½¿ç”¨nodeæ¥å¼€å¯ç®€å•çš„httpæœåŠ¡å™¨å¤„ç†webhookå‘é€çš„postè¯·æ±‚,è„šæœ¬éœ€è¦åŒ…å«åˆ›å»ºhttpæœåŠ¡å™¨ã€æ‹‰å–ä»“åº“ä»£ç ã€åˆ›å»ºé•œåƒå’Œå®¹å™¨ã€‚

åœ¨æœ¬åœ°é¡¹ç›®æ–°å»º`index.js`

```js
const http = require("http");
const { execSync } = require("child_process");
const path = require("path");
const fs = require("fs");

// é€’å½’åˆ é™¤ç›®å½•
function deleteFolderRecursive(path) {
  if (fs.existsSync(path)) {
    fs.readdirSync(path).forEach(function (file) {
      const curPath = path + "/" + file;
      if (fs.statSync(curPath).isDirectory()) {
        // recurse
        deleteFolderRecursive(curPath);
      } else {
        // delete file
        fs.unlinkSync(curPath);
      }
    });
    fs.rmdirSync(path);
  }
}

const resolvePost = (req) =>
  new Promise((resolve) => {
    let chunk = "";
    req.on("data", (data) => {
      chunk += data;
    });
    req.on("end", () => {
      resolve(JSON.parse(chunk));
    });
  });

http
  .createServer(async (req, res) => {
    console.log("receive request");
    console.log(req.url);
    if (req.method === "POST" && req.url === "/") {
      const data = await resolvePost(req);
      const projectDir = path.resolve(`./${data.repository.name}`);
      deleteFolderRecursive(projectDir);

      // æ‹‰å–ä»“åº“æœ€æ–°ä»£ç   data.repository.name å³ webhook ä¸­è®°å½•ä»“åº“åçš„å±æ€§
      execSync(
        `git clone https://github.com/wzc520pyfm/${data.repository.name}.git ${projectDir}`,
        {
          stdio: "inherit",
        }
      );
      // å¤åˆ¶ Dockerfile åˆ°é¡¹ç›®ç›®å½•
      fs.copyFileSync(
        path.resolve(`./Dockerfile`),
        path.resolve(projectDir, "./Dockerfile")
      );

      // å¤åˆ¶ .dockerignore åˆ°é¡¹ç›®ç›®å½•
      fs.copyFileSync(
        path.resolve(__dirname, `./.dockerignore`),
        path.resolve(projectDir, "./.dockerignore")
      );

      // åˆ›å»º docker é•œåƒ
      execSync(`docker build . -t ${data.repository.name}-image:latest `, {
        stdio: "inherit",
        cwd: projectDir,
      });

      // é”€æ¯ docker å®¹å™¨
      execSync(
        `docker ps -a -f "name=^${data.repository.name}-container" --format="{{.Names}}" | xargs -r docker stop | xargs -r docker rm`,
        {
          stdio: "inherit",
        }
      );

      // åˆ›å»º docker å®¹å™¨  -- è¿™é‡Œä½¿ç”¨äº†æœåŠ¡å™¨çš„8888ç«¯å£
      execSync(
        `docker run -d -p 8888:80 --name ${data.repository.name}-container  ${data.repository.name}-image:latest`,
        {
          stdio: "inherit",
        }
      );

      console.log("deploy success");
    }
    res.end("ok");
  })
  .listen(3000, () => {
    console.log("server is ready");
  });

```

åœ¨é”€æ¯ docker å®¹å™¨éƒ¨åˆ†ç”¨åˆ°äº† linux çš„ç®¡é“è¿ç®—ç¬¦å’Œ `xargs` å‘½ä»¤ï¼Œè¿‡æ»¤å‡ºä»¥ docker-test å¼€å¤´å®¹å™¨ï¼ˆç”¨ `docker-test` ä»“åº“çš„ä»£ç åˆ¶ä½œçš„é•œåƒåˆ›å»ºçš„å®¹å™¨ï¼‰ï¼Œåœæ­¢ï¼Œåˆ é™¤å¹¶é‡æ–°åˆ›å»ºå®ƒä»¬

æœ€å, é€šè¿‡scpå°†indexä¸Šä¼ åˆ°äº‘æœåŠ¡å™¨ä¸Š

> scp ./index.js root@121.5.110.8:/root

![image-20220127154500978](https://cdn.jsdelivr.net/gh/wzc520pyfm/Picbed_PicGo@master/img/image-20220127154500978.png)

ç°åœ¨, æˆ‘ä»¬çš„é¡¹ç›®ç»“æ„ä¸º: 

![image-20220127204833035](https://cdn.jsdelivr.net/gh/wzc520pyfm/Picbed_PicGo@master/img/image-20220127204833035.png)

äº‘æœåŠ¡å™¨ä¸Šä½¿ç”¨`pm2`è¿è¡Œindex.js

> pm2 start index.js

![image-20220127160209979](https://cdn.jsdelivr.net/gh/wzc520pyfm/Picbed_PicGo@master/img/image-20220127160209979.png)

* pm2å‘½ä»¤
  * `pm2 list`  æŸ¥çœ‹è¿è¡Œçš„pm2æœåŠ¡
  * `pm2 logs` æŸ¥çœ‹pm2æ—¥å¿—
  * `pm2 flush` æ¸…é™¤pm2æ—¥å¿—
  * `pm2 start index.js` è¿è¡Œindex.jsæ–‡ä»¶
  * `pm2 stop id` åœæ­¢æŒ‡å®šidçš„pm2æœåŠ¡

***å°æ’æ›²***

å› ä¸ºæˆ‘ä»¬éœ€è¦é€šè¿‡æœåŠ¡å™¨çš„8888ç«¯å£è®¿é—®éƒ¨ç½²çš„é¡¹ç›®, ä»“åº“éœ€è¦é€šè¿‡æœåŠ¡å™¨3000ç«¯å£é€šçŸ¥æœåŠ¡å™¨ä»£ç æ›´æ–°, æ‰€ä»¥æœåŠ¡å™¨éœ€è¦æ”¾é€š8888å’Œ3000ç«¯å£, ä¸‹é¢ä»‹ç»è…¾è®¯äº‘æœåŠ¡å™¨æ”¾é€šç«¯å£çš„æ­¥éª¤: 

1. ![image-20220127204350525](https://cdn.jsdelivr.net/gh/wzc520pyfm/Picbed_PicGo@master/img/image-20220127204350525.png)
2. ![image-20220127204509146](https://cdn.jsdelivr.net/gh/wzc520pyfm/Picbed_PicGo@master/img/image-20220127204509146.png)

æ¥ç€å°±å¯ä»¥è®¿é—® http://æœåŠ¡å™¨ip:8888  çœ‹åˆ°é¡µé¢,  å¦‚æœæ— å“åº”, å°è¯•å‘ä»“åº“pushä¸€æ¬¡ä»£ç , æŸ¥çœ‹pm2æ—¥å¿—æ˜¯å¦æˆåŠŸæ‹‰å–ä»£ç å¹¶æ›´æ–°é•œåƒ, å¦‚æœå‡ºç°ç½‘ç»œé—®é¢˜æ— æ³•æ‹‰å–ä»£ç , æœ€å¥½æ˜¯æ”¹ç”¨giteeä»“åº“, giteeçš„webhooké…ç½®è®¿é—®ä¸githubä¸€è‡´.

![image-20220127202846153](https://cdn.jsdelivr.net/gh/wzc520pyfm/Picbed_PicGo@master/img/image-20220127202846153.png)

![image-20220127202906803](https://cdn.jsdelivr.net/gh/wzc520pyfm/Picbed_PicGo@master/img/image-20220127202906803.png)



æ¥ä¸‹æ¥å¯¹é¡¹ç›®ä¸­çš„App.vueç¨ä½œæ›´æ”¹,å¹¶æäº¤ä»“åº“, æµ‹è¯•è‡ªåŠ¨åŒ–éƒ¨ç½²

![image-20220127203640027](https://cdn.jsdelivr.net/gh/wzc520pyfm/Picbed_PicGo@master/img/image-20220127203640027.png)

é‡æ–°æ‰“å¼€ http://æœåŠ¡å™¨ip:8888  

![image-20220127203724224](https://cdn.jsdelivr.net/gh/wzc520pyfm/Picbed_PicGo@master/img/image-20220127203724224.png)

å¯ä»¥çœ‹åˆ°å†…å®¹å·²ç»æ›´æ–°

### ç¤ºä¾‹ä»£ç 

[wzc520pyfm/docker-test - ç äº‘ - å¼€æºä¸­å›½ (gitee.com)](https://gitee.com/wzc520pyf/docker-test/tree/master)

å…³æ³¨ Dockerfile ï¼Œ.dockerignoreï¼Œ index.js æ–‡ä»¶



### è·ç¦»çœŸå®ç¯å¢ƒä»æœ‰ä¸€å®šå·®è·

ä¸Šè¿° demo åªåˆ›å»ºäº†å•ä¸ª docker å®¹å™¨ï¼Œå½“é¡¹ç›®æ›´æ–°æ—¶ï¼Œç”±äºå®¹å™¨éœ€è¦ç»è¿‡é”€æ¯å’Œåˆ›å»ºçš„è¿‡ç¨‹ï¼Œä¼šå­˜åœ¨ä¸€æ®µæ—¶é—´é¡µé¢æ— æ³•è®¿é—®æƒ…å†µ

è€Œå®é™…æŠ•å…¥ç”Ÿäº§æ—¶ä¸€èˆ¬ä¼šåˆ›å»ºå¤šä¸ªå®¹å™¨ï¼Œå¹¶é€æ­¥æ›´æ–°æ¯ä¸ªå®¹å™¨ï¼Œé…åˆè´Ÿè½½å‡è¡¡å°†ç”¨æˆ·çš„è¯·æ±‚æ˜ å°„åˆ°ä¸åŒç«¯å£çš„å®¹å™¨ä¸Šï¼Œç¡®ä¿çº¿ä¸Šçš„æœåŠ¡ä¸ä¼šå› ä¸ºå®¹å™¨çš„æ›´æ–°è€Œå®•æœº

![image-20200701210630305](https://cdn.jsdelivr.net/gh/wzc520pyfm/Picbed_PicGo@master/img/1730b001c8c5e896tplv-t2oaga2asx-watermark.awebp)

å¦å¤–åŸºäº github å¹³å°ä¹Ÿæœ‰éå¸¸æˆç†Ÿçš„ CI/CD å·¥å…·ï¼Œä¾‹å¦‚

- [travis-ci](https://www.travis-ci.com/?_gl=1*iao225*_ga*MTQwNzA2MDQ5Ni4xNjQzMjg4MzU5*_ga_XRYGSZFQ0P*MTY0MzI4ODM1OS4xLjAuMTY0MzI4ODM1OS42MA..)
- [circleci](https://link.juejin.cn/?target=https%3A%2F%2Fcircleci.com%2F)

é€šè¿‡ yml é…ç½®æ–‡ä»¶ï¼Œç®€åŒ–ä¸Šæ–‡ä¸­æ³¨å†Œ webhook å’Œç¼–å†™æ›´æ–°å®¹å™¨çš„ index.js è„šæœ¬çš„æ­¥éª¤

```yml
# .travis.yml
language: node_js
node_js:
  - 8
branchs:
  only:
    - master
cache:
  directories:
    - node_modules
install:
  - yarn install
scripts:
  - yarn test
  - yarn build
```

å¦å¤–éšç€ç¯å¢ƒçš„å¢å¤šï¼Œå®¹å™¨ä¹Ÿä¼šé€æ¸å¢åŠ ï¼Œdocker ä¹Ÿæ¨å‡ºäº†æ›´å¥½ç®¡ç†å¤šä¸ªå®¹å™¨çš„æ–¹å¼ [docker-compose](https://link.juejin.cn/?target=https%3A%2F%2Fdocs.docker.com%2Fcompose%2F)

![img](https://cdn.jsdelivr.net/gh/wzc520pyfm/Picbed_PicGo@master/img/173007913eecf406tplv-t2oaga2asx-watermark.awebp)

